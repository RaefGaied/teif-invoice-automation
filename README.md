<div align="center">
  <h1>üîÑ TEIF Invoice Converter</h1>
  <h3>Conversion Automatique de Factures PDF vers le Format TEIF 1.8.8</h3>
  <img src="https://img.shields.io/badge/Version-1.0.0-blue" alt="Version">
  <img src="https://img.shields.io/badge/Python-3.7+-blue" alt="Python Version">
  <img src="https://img.shields.io/badge/License-MIT-green" alt="License">
</div>

<div align="center">
  <img src="https://via.placeholder.com/800x200/2a2a72/ffffff?text=TEIF+Converter" alt="TEIF Converter Logo" width="100%">
  <p><em>Solution professionnelle de conversion de factures √©lectroniques conforme aux normes tunisiennes</em></p>
</div>


## Table of Contents

- [Description](#description)
  - [Fonctionnalit√©s principales](#fonctionnalit√©s-principales)
- [Structure TEIF XML](#structure-teif-xml)
  - [Structure de Base](#structure-de-base)
  - [Points Importants](#points-importants)
- [Architecture du Projet](#architecture-du-projet)
  - [Vue d'ensemble](#vue-densemble)
  - [Workflow Principal](#workflow-principal)
  - [Architecture D√©taill√©e des Composants](#architecture-d√©taill√©e-des-composants)
  - [Processus de G√©n√©ration XML TEIF](#processus-de-g√©n√©ration-xml-teif)
  - [Structure XML et S√©quence des √âtapes](#structure-xml-et-s√©quence-des-√©tapes)
  - [Processus de G√©n√©ration de Signature](#processus-de-g√©n√©ration-de-signature)
  - [Flux de Donn√©es et Validation](#flux-de-donn√©es-et-validation)
  - [L√©gende des Diagrammes](#l√©gende-des-diagrammes)
- [Fonctionnalit√©s Cl√©s](#fonctionnalit√©s-cl√©s)
  - [Signature √âlectronique XAdES-B](#signature-√©lectronique-xades-b)
  - [Conformit√© TEIF](#conformit√©-teif)
  - [Architecture Modulaire](#architecture-modulaire)
- [Impl√©mentation Technique](#impl√©mentation-technique)
  - [Composants de la Section de Signature](#composants-de-la-section-de-signature)
  - [Architecture du Flux de Donn√©es](#architecture-du-flux-de-donn√©es)
- [Structure du Projet](#structure-du-projet)
  - [Fichiers Racine Importants](#fichiers-racine-importants)
  - [Fichiers de Configuration](#fichiers-de-configuration)
- [Description des Composants Cl√©s](#description-des-composants-cl√©s)
- [Installation](#installation)
  - [Pr√©requis](#pr√©requis)
  - [Installation des d√©pendances](#installation-des-d√©pendances)
  - [D√©pendances principales](#d√©pendances-principales)
- [Utilisation](#utilisation)
  - [Conversion d'un fichier PDF](#conversion-dun-fichier-pdf)
  - [Sp√©cifier un dossier de sortie](#sp√©cifier-un-dossier-de-sortie)
  - [Aper√ßu sans sauvegarde](#aper√ßu-sans-sauvegarde)
  - [Tester avec des donn√©es d'exemple](#tester-avec-des-donn√©es-dexemple)
  - [Aide](#aide)
- [Signature XAdES](#signature-xades)
  - [G√©n√©ration de la signature](#g√©n√©ration-de-la-signature)
  - [Ajout de la signature √† la facture](#ajout-de-la-signature-√†-la-facture)
- [Contribution](#contribution)
- [Licence](#licence)
- [Auteur](#auteur)
- [Remerciements](#remerciements)



Convertisseur automatique de factures PDF vers le format TEIF (Tunisian Electronic Invoice Format) conforme aux standards TTN (Tunisie TradeNet) version 1.8.8.

## Description

Ce projet Python extrait automatiquement les donn√©es de factures depuis des fichiers PDF et les convertit en format XML TEIF conforme au standard tunisien d'√©change √©lectronique de factures (version 1.8.8).

### Fonctionnalit√©s principales

- **Extraction intelligente** : Analyse avanc√©e du contenu des PDFs pour extraire les donn√©es de facture
- **Conformit√© TEIF 1.8.8** : G√©n√®re du XML strictement conforme au standard TTN
- **Pr√©servation des donn√©es** : Utilise les montants et taxes exactement comme trouv√©s dans le PDF, sans recalcul
- **Support multi-format** : Fonctionne avec diff√©rents formats de factures PDF
- **Architecture modulaire** : Code organis√© en modules clairs et maintenables
- **Validation int√©gr√©e** : V√©rification de la conformit√© du XML g√©n√©r√©
- **G√©n√©ration de signatures** : Support pour les signatures XAdES (optionnel)

## Structure TEIF XML

Le format TEIF (Tunisian Electronic Invoice Format) suit une structure XML sp√©cifique. Voici un aper√ßu des √©l√©ments principaux :

### Structure de Base

```xml
<TEIF>
  <Header>
    <DocumentType>INVOICE</DocumentType>
    <DocumentNumber>FACT-2023-001</DocumentNumber>
    <DocumentDate>2023-01-01</DocumentDate>
    <Currency>DINAR TUNISIEN</Currency>
    <CurrencyCode>TND</CurrencyCode>
  </Header>
  
  <Seller>
    <Name>NOM DU VENDEUR</Name>
    <TaxIdentifier>
      <ID>IDENTIFIANT FISCAL</ID>
      <Type>FISCAL_NUMBER</Type>
    </TaxIdentifier>
  </Seller>
  
  <Buyer>
    <Name>NOM DE L'ACHETEUR</Name>
    <TaxIdentifier>...</TaxIdentifier>
  </Buyer>
  
  <Invoice>
    <InvoiceHeader>...</InvoiceHeader>
    <InvoiceLines>
      <Line>
        <LineNumber>1</LineNumber>
        <Item>
          <Description>DESCRIPTION DE L'ARTICLE</Description>
          <Quantity>1.000</Quantity>
          <UnitPrice>100.000</UnitPrice>
        </Item>
        <Moa amountTypeCode="I-181" currencyCodeList="ISO_4217">
          <Amount currencyIdentifier="TND">100.000</Amount>
          <AmountDescription lang="FR">Montant hors taxes</AmountDescription>
        </Moa>
      </Line>
    </InvoiceLines>
    
    <InvoiceTotals>
      <Moa amountTypeCode="I-181" currencyCodeList="ISO_4217">
        <Amount currencyIdentifier="TND">100.000</Amount>
        <AmountDescription lang="FR">Total hors taxes</AmountDescription>
      </Moa>
      <Moa amountTypeCode="I-182" currencyCodeList="ISO_4217">
        <Amount currencyIdentifier="TND">19.000</Amount>
        <AmountDescription lang="FR">Total TVA</AmountDescription>
      </Moa>
      <Moa amountTypeCode="I-183" currencyCodeList="ISO_4217">
        <Amount currencyIdentifier="TND">119.000</Amount>
        <AmountDescription lang="FR">Total TTC</AmountDescription>
      </Moa>
    </InvoiceTotals>
  </Invoice>
  
  <Signature>...</Signature>
</TEIF>
```


### Points Importants

1. **En-t√™te (Header)**
   - Contient les informations de base du document
   - Inclut le type de document, num√©ro, date et devise

2. **Vendeur et Acheteur**
   - Sections d√©di√©es pour les informations des parties
   - Inclut les identifiants fiscaux

3. **Lignes de Facture**
   - Chaque ligne contient un article ou service
   - Inclut la description, quantit√©, prix unitaire et montant HT

4. **Totaux**
   - Montant HT
   - Montant TVA
   - Montant TTC
   - Autres totaux sp√©cifiques

5. **Signature**
   - Signature √©lectronique XAdES
   - Optionnelle selon le cas d'utilisation

### Attributs Sp√©ciaux

- `currencyCodeList="ISO_4217"` : Obligatoire pour tous les √©l√©ments MOA
- `amountTypeCode` : Code indiquant le type de montant (ex: I-181 pour HT, I-182 pour TVA, etc.)
- `currencyIdentifier` : Code devise (TND pour Dinar Tunisien)

Pour plus de d√©tails, consultez le fichier `docs/TEIF_XML_Structure_Analysis.md`.


## Architecture du Projet

### Vue d'ensemble

L'architecture du projet est con√ßue pour assurer une s√©paration claire des responsabilit√©s et une facilit√© de maintenance. Le syst√®me int√®gre un flux de travail complet pour la conversion et la signature √©lectronique de documents TEIF conformes aux standards Tunisie TradeNet.

### Workflow Principal

![Workflow Principal](https://github.com/user-attachments/assets/64f109ab-fc9c-4c1c-bfd0-37f81d51b088)

### Architecture D√©taill√©e des Composants

![Architecture D√©taill√©e](https://github.com/user-attachments/assets/ba503358-b287-4743-8543-ec25e9bd1af8)

### Processus de G√©n√©ration XML TEIF

![Processus de G√©n√©ration XML](https://github.com/user-attachments/assets/0b07bdd3-41c5-4461-82f0-4c7594c2317f)

![G√©n√©ration XML D√©taill√©e](https://github.com/user-attachments/assets/a0f4b888-7210-43ae-92e3-55eea854d36c)

### Structure XML et S√©quence des √âtapes

![Structure XML](https://github.com/user-attachments/assets/2d1bbd60-fb42-4151-b87c-1277f4eed44b)

![S√©quence des √âtapes](https://github.com/user-attachments/assets/325185fa-4e5f-4d72-aa92-5deaf4522e9c)

### Processus de G√©n√©ration de Signature

![G√©n√©ration de Signature](https://github.com/user-attachments/assets/ac16648b-6f0d-4c25-a445-eca2c663c9e5)

### Flux de Donn√©es et Validation

![Flux de Donn√©es](https://github.com/user-attachments/assets/bf20c4d1-288a-4e6b-b2ae-18d977ed0248)

### L√©gende des Diagrammes

- **En rose** : Point d'entr√©e principal (CLI)
- **En bleu clair** : Fichiers d'entr√©e/sortie
- **En vert clair** : Fichiers de configuration
- **Bo√Ætes blanches** : Composants principaux

## Fonctionnalit√©s Cl√©s

### Signature √âlectronique XAdES-B

- **SignedInfo** : Contient la m√©thode de canonicalisation, la m√©thode de signature et les r√©f√©rences du document
- **SignatureValue** : Signature RSA-SHA256 de l'√©l√©ment SignedInfo
- **KeyInfo** : Informations du certificat X.509 pour la v√©rification de signature
- **QualifyingProperties** : Propri√©t√©s sp√©cifiques XAdES incluant l'heure de signature et les d√©tails du certificat

### Conformit√© TEIF

- **TTN Version 1.8.8** : Conformit√© compl√®te avec les sp√©cifications Tunisie TradeNet
- **Structure XML** : Structure de document TEIF correcte avec tous les √©l√©ments requis
- **Validation** : Validation multi-niveaux pour l'int√©grit√© des donn√©es et la conformit√© du format
- **S√©curit√©** : Signatures XAdES-B pour l'authenticit√© et la non-r√©pudiation des documents

### Architecture Modulaire

- **Extracteurs** : Extraction et normalisation des donn√©es PDF
- **G√©n√©rateurs** : G√©n√©ration des sections XML TEIF
- **Validateurs** : Validation des donn√©es et de la structure XML
- **Interface CLI** : Outil en ligne de commande pour le traitement par lots

## Impl√©mentation Technique

### Composants de la Section de Signature

- **Gestion des namespaces** : Gestion appropri√©e des namespaces XML pour les pr√©fixes ds: et xades:
- **Gestion des certificats** : Chargement et validation des certificats X.509
- **Calcul d'empreinte** : Calcul de hash SHA-256 pour l'int√©grit√© du document
- **Canonicalisation** : XML-EXC-C14N pour une repr√©sentation XML coh√©rente
- **Transformations XPath** : Filtrage et traitement des r√©f√©rences de document

### Architecture du Flux de Donn√©es

- **Couche d'entr√©e** : Fichiers PDF, configuration et certificats
- **Couche de traitement** : Extraction, normalisation et validation
- **Couche de g√©n√©ration** : Cr√©ation de la structure XML TEIF
- **Couche de s√©curit√©** : Application de la signature XAdES-B
- **Couche de sortie** : XML TEIF sign√© conforme aux standards TTN


## Structure du Projet

```
TTN/
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ main.yml
‚îú‚îÄ‚îÄ certs/
‚îÇ   ‚îú‚îÄ‚îÄ ca.crt
‚îÇ   ‚îú‚îÄ‚îÄ ca.key
‚îÇ   ‚îú‚îÄ‚îÄ server.crt
‚îÇ   ‚îî‚îÄ‚îÄ server.key
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ TEIF_XML_Structure_Analysis.md
‚îÇ   ‚îú‚îÄ‚îÄ teif_xml_structure_example.xml
‚îÇ   ‚îî‚îÄ‚îÄ XADES_SIGNATURE.md
‚îú‚îÄ‚îÄ examples/
‚îÇ   ‚îî‚îÄ‚îÄ sign_teif_invoice.py
‚îú‚îÄ‚îÄ extracted_data/
‚îú‚îÄ‚îÄ legacy/
‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îú‚îÄ‚îÄ transform_invoice.py
‚îÇ   ‚îî‚îÄ‚îÄ transform_invoice_simple.py
‚îú‚îÄ‚îÄ output/
‚îÇ   ‚îî‚îÄ‚îÄ complete_invoice.xml
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ teif-invoices/
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ generate_test_cert.py
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ cli/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ extractors/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ teif/
‚îÇ       ‚îú‚îÄ‚îÄ sections/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ amounts.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ common.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ header.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ lines.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ partner.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ payment.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ references.py
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ signature.py
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ taxes.py
‚îÇ       ‚îú‚îÄ‚îÄ utils/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ generator.py
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_data/
‚îÇ   ‚îú‚îÄ‚îÄ test_output/
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py
‚îÇ   ‚îú‚îÄ‚îÄ test_signature.py
‚îÇ   ‚îî‚îÄ‚îÄ test_*.py
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ .pytest_cache/
‚îú‚îÄ‚îÄ .vscode/
‚îú‚îÄ‚îÄ .venv/
‚îú‚îÄ‚îÄ .idea/
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ setup.py
‚îú‚îÄ‚îÄ openssl.cnf
‚îî‚îÄ‚îÄ debug_extraction.py
```

### Fichiers Racine Importants
- `main.py` : Point d'entr√©e principal de l'application
- `requirements.txt` : D√©pendances du projet
- `setup.py` : Configuration du package Python
- `openssl.cnf` : Configuration OpenSSL pour la g√©n√©ration de certificats
- `debug_extraction.py` : Utilitaire de d√©bogage pour l'extraction

### Fichiers de Configuration
- `.gitignore` : Fichiers ignor√©s par Git
- `.pytest_cache/` : Cache des tests
- `.vscode/` : Configuration VS Code
- `.venv/` : Environnement virtuel Python
- `.idea/` : Configuration PyCharm/IntelliJ

## Description des Composants Cl√©s

1. **G√©n√©rateur TEIF** (`src/teif/generator.py`)
   - Classe principale pour la g√©n√©ration de documents TEIF
   - G√®re la cr√©ation de la structure XML
   - Coordonne les diff√©rents modules de g√©n√©ration

2. **Modules de Sections** (`src/teif/sections/`)
   - `header.py`: Gestion de l'en-t√™te TEIF et des m√©tadonn√©es
   - `partner.py`: Gestion des parties (vendeur, acheteur, livraison)
   - `lines.py`: G√©n√©ration des lignes de facture
   - `taxes.py`: Calcul et application des taxes
   - `payment.py`: Conditions et moyens de paiement
   - `amounts.py`: Gestion des montants et devises
   - `common.py`: Fonctions utilitaires partag√©es

3. **Interface en Ligne de Commande** (`src/cli/`)
   - Point d'entr√©e pour l'utilisation en ligne de commande
   - Gestion des arguments et options
   - Gestion des erreurs et journalisation

4. **Tests** (`tests/`)
   - Tests unitaires pour chaque composant
   - Tests d'int√©gration
   - Donn√©es de test et r√©sultats attendus

5. **Utilitaires** (`scripts/`)
   - Scripts pour la gestion des certificats
   - Outils de d√©veloppement

## Installation

### Pr√©requis

- Python 3.7 ou plus r√©cent
- pip (gestionnaire de paquets Python)

### Installation des d√©pendances

```bash
pip install -r requirements.txt
```

### D√©pendances principales

- `pdfplumber` : Extraction de texte depuis les PDFs
- `PyPDF2` : Fallback pour l'extraction PDF
- `lxml` : G√©n√©ration et validation XML
- `signxml` : Signature XAdES (optionnel)

## Utilisation

### Conversion d'un fichier PDF

```bash
python main.py facture.pdf
```

### Sp√©cifier un dossier de sortie

```bash
python main.py facture.pdf -o ./output
```

### Aper√ßu sans sauvegarde

```bash
python main.py facture.pdf --preview
```

### Tester avec des donn√©es d'exemple

```bash
python test_teif_generator.py tests/sample_invoice.pdf
```

### Aide

```bash
python main.py --help
```

## Architecture technique

### Extraction des donn√©es

Le module `extractors` est responsable de l'extraction des donn√©es depuis les fichiers PDF. Il utilise une approche hybride :

1. Extraction du texte brut avec `pdfplumber`
2. Analyse syntaxique pour identifier les champs cl√©s
3. Validation et normalisation des donn√©es extraites

### G√©n√©ration TEIF

Le module `teif` g√®re la g√©n√©ration du XML conforme au standard TEIF 1.8.8 :

- Structure XML valid√©e par sch√©ma XSD
- Support des √©l√©ments obligatoires et conditionnels
- Gestion des formats de donn√©es sp√©cifiques (dates, montants, etc.)

## Signature XAdES

Le projet prend en charge les signatures XAdES-BES pour les factures TEIF. La signature est g√©n√©r√©e √† l'aide de la biblioth√®que `signxml`.

### G√©n√©ration de la signature

Pour g√©n√©rer une signature XAdES, vous devez fournir un certificat et une cl√© priv√©e. Vous pouvez utiliser les outils de g√©n√©ration de certificats pour cr√©er un certificat et une cl√© priv√©e.

```bash
python scripts/generate_test_cert.py
```

Cela cr√©era les fichiers suivants dans le r√©pertoire `certs` :

- `ca.crt` - Certificat de l'autorit√© de certification
- `ca.key` - Cl√© priv√©e de l'AC
- `server.crt` - Certificat du serveur
- `server.key` - Cl√© priv√©e du serveur

### Ajout de la signature √† la facture

Pour ajouter la signature √† la facture, vous devez utiliser la classe `SignatureSection` du module `teif`.

```python
from src.teif.sections.signature import SignatureSection

# Cr√©ez une section de signature
signature = SignatureSection()

# Ajoutez la signature avec le certificat et la cl√© priv√©e
with open('certs/server.crt', 'rb') as f:
    cert_data = f.read()

with open('certs/server.key', 'rb') as f:
    key_data = f.read()

signature.add_signature(
    cert_data=cert_data,
    key_data=key_data,
    key_password=None,  # Ajoutez un mot de passe si la cl√© est chiffr√©e
    signature_id='SIG-001',
    role='supplier',
    name='Votre nom d\'entreprise'
)

# Signez le document XML
signature.sign_document(votre_facture_xml_root)
```

## Contribution

Les contributions sont les bienvenues ! Pour contribuer :

1. Forkez le d√©p√¥t
2. Cr√©ez une branche pour votre fonctionnalit√© (`git checkout -b feature/ma-nouvelle-fonctionnalite`)
3. Committez vos changements (`git commit -am 'Ajout d\'une nouvelle fonctionnalit√©'`)
4. Poussez vers la branche (`git push origin feature/ma-nouvelle-fonctionnalite`)
5. Cr√©ez une Pull Request

## Licence

Ce projet est sous licence MIT. Voir le fichier `LICENSE` pour plus de d√©tails.

## Auteur

- **Raef Gaied**

## Remerciements

- L'√©quipe TTN pour la documentation du standard TEIF
- La communaut√© Python pour les biblioth√®ques utilis√©es
- Tous les contributeurs qui ont aid√© √† am√©liorer ce projet
